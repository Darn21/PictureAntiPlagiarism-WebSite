{% extends "process_app/base.html" %}
{% block content %}

        <script  type="text/javascript"
                 src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js">
        </script>

        <script  type="text/javascript">
            function sleep(ms) {
               return new Promise(resolve => setTimeout(resolve, ms));
            }
        </script>

        <script  type="text/javascript">
            // Отображение загруженного изображения
            function renderImage(input) {
                if (input.files && input.files[0]) {
                    var reader = new FileReader();

                    reader.onload = function (e) {
                        $('#render').attr('src', e.target.result);
                    }

                    reader.readAsDataURL(input.files[0]); // convert to base64 string
                }
            }
        </script>

<!--        <script  type="text/javascript">-->
<!--            // Отправка формы-->
<!--            async function sendImage(form) {-->
<!--                event.preventDefault();-->
<!--                const scriptURL = "";-->

<!--                let response = await fetch(scriptURL, {-->
<!--                    method: 'POST',-->
<!--                    body: new FormData(form)-->
<!--                })-->

<!--                let result = await response.json();-->
<!--                document.getElementById('result').innerHTML = result.message; //сервер должен вернуть ответ в формате "{message:'Ваше изображение - фейк'}"-->

<!--                document.getElementById('top').querySelector('lds-facebook').remove();-->
<!--            }-->
<!--        </script>-->


        <script  type="text/javascript">
            // Обработка нажатия на кнопку
            var flag = false;
            $("document").ready(function () {

                $('#image_input').on('change', () => {
                    document.getElementById('result').innerHTML = "";
                    var exp = $('#image_input').val().split('.').pop().toString();
                    if (!(exp == 'png' || exp == 'jpg')) {
                        document.getElementById('result').innerHTML = "Ошибка!" + '<br />' +
                                                        "Выберите изображения .jpg или .png";
                        flag = false;
                    }
                    else {
                        flag = true;
                    }
                });

                $('#upload_image_form').on('submit', () => {
                    const $files = $('#image_input').get(0).files

                    if ($files.length) {
                        // Reject big files
                        if ($files[0].size > $(this).data("max-size") * 1024) {
                            flag = false
                        }

                        if (flag) {
                            // Анимация загрузки
                            var loading = document.createElement('div');
                            loading.classList.add('lds-facebook');
                            loading.innerHTML = "<div></div><div></div><div></div>";
                            document.getElementById('top').appendChild(loading);
                        }
                        else {

                        }
                    }
                    else {

                    }
                });
            });

            function myFunction() {
                if (flag) return true;
                else return false;
            }
        </script>

<!--        <script lang="javascript">-->
<!--            $('#upload_image_form').submit(function(event){-->
<!--                var text = $(this).find('input[type="name"]');-->
<!--                if( text.val().split('.').pop() == 'jpeg' ){-->
<!--                   return true;-->
<!--                }-->
<!--                else {-->
<!--                    document.getElementById('result').innerHTML = "Выберите изображения .jpeg или .png";-->
<!--                    return false;-->
<!--                }-->
<!--            });-->
<!--        </script>-->


        <form id="upload_image_form" method="post" enctype="multipart/form-data"
              onsubmit="return myFunction();" action="{% url 'process_app:upload_image' %}">
            {% csrf_token %}
            <p>Загрузите картину в формате JPEG, PNG</p>
            <p>
                <input id = "image_input" type="file" class="imgur" name="img"
                       accept="image/*" onchange="renderImage(this)">
                <input type="submit" value="Отправить на проверку">
            </p>
        </form>
        <img id='render' src="" >
        <div id='result'> </div>
{% endblock content %}